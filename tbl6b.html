
<html>
    <head>
<meta charset="UTF-8">
  <script src="jquery.min.js"></script>
  <script src="moment.min.js"></script>
  <script src="angular.min.js"></script>
  <script src="dirPagination.js"></script>
    <link rel="stylesheet" href="w3.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="material.min.css">
<script defer src="material.min.js"></script>
  <style>
</style>
    </head>
    <body >	
	<div ng-app="myApp">	
<div  ng-controller="formCtrl3">
<div ng-include="'b4.html'"></div>	
<div class="w3-row w3-container">
    <div class="w3-col l4 m4 s4">
	 Fecha: <input ng-model="tbl.dat1">
	Hora: <input ng-model="tbl.time1">
	</div>
	<div class="w3-col l8 m8 s8">
	Seleccionar Cliente: <input type="checkbox" ng-model="myVar"   ng-click="refreshTbl2s()" >
	<input type="hidden" ng-model="tbl.tbl4s_id" >
	<input type="text" ng-model="tbl4_selected.str1" >
	<div ng-hide="!myVar">						
					<table  class="" >
						<thead  ><td ng-repeat="n in headers2">{{n.header}}
						<input type="text" ng-model="filters[n.column]" placeholder={{n.header}}></td></thead>
						<tr ng-repeat="a in tbl4s | filter:{id:filters.id} | filter:{str1:filters.str1} | filter:{str2:filters.str2} | filter:{str3:filters.str3}| filter:{str4:filters.str4}| filter:{str5:filters.str5} ">
							<td ng-click="select_tbl4(a)"  ng-repeat="x in headers2">{{a[x.column]}}</td>
 -->						</tr>
					</table>
							</div>
	</div>
	</div>
	
	<div class="w3-row w3-container">
	<div class="w3-col l12 m12 s12">	
			Seleccionar Ubicaci√≥n: <input type="checkbox" ng-model="myVar2"   ng-click="refreshTblas()" >
	<input type="hidden" ng-model="tbl.tblas_id" >
	<input type="text" ng-model="tbla_selected.str1" >
	<div ng-hide="!myVar2">						
					<table  class="table  table-sm  let1" >
						<thead  ><td ng-repeat="n in headers5">{{n.header}}
						<input type="text" ng-model="filters[n.column]" placeholder={{n.header}}></td></thead>
						<tr ng-repeat="a in tblas | filter:{id:filters.id} | filter:{str1:filters.str1} | filter:{str2:filters.str2} | filter:{str3:filters.str3}| filter:{str4:filters.str4}| filter:{str5:filters.str5} ">
							<td ng-click="select_tbla(a)"  ng-repeat="x in headers2">{{a[x.column]}}</td>
							<!-- <td><button ng-hide={{show}} ng-click="select(a)" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-ok"></span>Seleccionar</button>
							<button ng-hide={{show}} ng-click="deleteTbl2(a)" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-remove"></span>Eliminar</button>
							<button ng-hide={{!show}} ng-click="restore(a)" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-remove"></span>Restaurar</button></td>
 -->						</tr>
					</table>
					<div ng-click="select_tbla(a)" ng-class="getClass()" class="w3-col l1 c1" ng-repeat="a in tblas"> 
								{{a.str1}} 
					</div>
							</div>

			Seleccionar empleado: <input type="checkbox" ng-model="myVar3"   ng-click="refreshTblbs()" >
	<input type="hidden" ng-model="tbl.tblbs_id" >
	<input type="text" ng-model="tblb_selected.str1" >
	<div ng-hide="!myVar3">						
					<table  class="" >
						<thead  ><td ng-repeat="n in headers6">{{n.header}}
						<input type="text" ng-model="filters[n.column]" placeholder={{n.header}}></td></thead>
						<tr ng-repeat="a in tblbs | filter:{id:filters.id} | filter:{str1:filters.str1} | filter:{str2:filters.str2} | filter:{str3:filters.str3}| filter:{str4:filters.str4}| filter:{str5:filters.str5} ">
							<td ng-click="select_tblb(a)"  ng-repeat="x in headers2">{{a[x.column]}}</td>
							<!-- <td><button ng-hide={{show}} ng-click="select(a)" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-ok"></span>Seleccionar</button>
							<button ng-hide={{show}} ng-click="deleteTbl2(a)" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-remove"></span>Eliminar</button>
							<button ng-hide={{!show}} ng-click="restore(a)" type="button" class="btn btn-primary"> <span class="glyphicon glyphicon-remove"></span>Restaurar</button></td>
 -->						</tr>
					</table>
							</div>
		</div>
		</div>			
			<div class="w3-row w3-row w3-container">
  <div class="w3-col l5 m5 s5  w3-center">
  <div class="w3-black w3-jumbo">
		<p >	Id Pedido: {{tbl6s_selected.id}} </p>			
	</div>
  
  <h2>Servicios A Pagar</h2> 
	<table  class="w3-table w3-orange">
						<thead  ><td ng-repeat="n in headers4  | filter:{show:1}">{{n.header}}
						<!-- <input type="text" ng-model="filters[n.column]" placeholder={{n.header}}> -->
						</td></thead>
						<tr contenteditable="true" ng-repeat="a in tbl7s_list  track by $index">
							<td    ng-click="updateTotals()"  ng-repeat="x in headers4  | filter:{show:1}">
							<div ng-if="x.column == 'ent1' || x.column == 'ent2' || x.column == 'ent3' ">{{a[x.column]  | number}}</div>
							<div ng-if="x.column != 'ent1' && x.column != 'ent2' && x.column != 'ent3'">{{a[x.column]}}</div>
							</td>
							<td><p  ng-click="delete_tbl7s(a)"><i class="fa fa-window-close w3-red w3-xlarge"></i></p></td>
						</tr>
					<tfoot>
					<tr >
							<td ng-repeat="x in headers4  | filter:{show:1}">
							<div ng-if="x.column == 'ent1' || x.column == 'ent2' || x.column == 'ent3' ">{{total[x.column]  | number}}</div>
							<div ng-if="x.column != 'ent1' && x.column != 'ent2' && x.column != 'ent3'">{{total[x.column]}}</div>
							
						</tr>
				</tfoot>
				</table>
  </div>
  <div class="w3-col l7 m7 s7  w3-center ">
  <div ng-click="select_tbl5(a)" ng-repeat="a in tbl5s"  class="w3-card-4 w3-bar">
				<img class="w3-circle size_image_products" ng-src="uploads/{{a.filename}}" >
				<p>{{a.str2}}</p> <p class="w3-red w3-large">{{a.ent1 | number}} Gs</p>
			</div>
  </div>
</div>
   
 <div class="w3-row  w3-container">
    <div class="w3-col l12 m12 s12  w3-center">
				<p class="buttons-row">	<button type="button" ng-click="saveTbl()" class="btn btn-primary">Crear Pago</button>
					<button type="button" ng-click="updateTbl()" class="btn btn-primary">Actualizar</button>
										<button type="button" ng-click="refreshTbls()" class="btn btn-primary">Solo Activos</button>
					<button type="button" ng-click="refreshTblsAll()" class="btn btn-primary">Listar Todos</button> </p> 
    </div> 
</div>


<div class="w3-row">
 <div class="w3-col l12 m12 s12  w3-center ">
  <div  ng-click="select_tbl6s(a)" ng-repeat="a in tbl6s"  class="w3-card-4 w3-bar">
  
				<p "w3-green w3-large">Hora de pedido: {{a.time1}}</p> 
				<p class="w3-green w3-large">{{a.ent1 | number}} Gs</p>
				<td><p  ng-click="delete_tbl6s(a)"><i class="fa fa-window-close w3-red w3-xlarge"></i></p></td>
			</div>
  </div>
	
 </div>				
	     <script >
		var app = angular.module('myApp', ['angularUtils.directives.dirPagination']);
		app.controller('formCtrl3', function($scope,$http) {
		$scope.mensajes = [];
		$scope.get_url_tbl6s = "api.php/tbl6s?order=id,desc&filter[]=del1,eq,0&filter[]=bol1,eq,0";
//refresh refreshTblws		
		$scope.refreshTbl2s = function() {
		console.log("Tbl4s ya cargadoooo.....");	
		console.log($scope.tbl4_id);
		$scope.tbl4_selected = {};
		$scope.tbl5_selected = {};
		$scope.tbl7s = {};
		$scope.total = {};
			$scope.tbl2s = [];	
			$scope.tbl7s_list = []; //Alamcena la listra de Detalles de tbl6s
			$http.get("api.php/tbl4s?order=id,desc&filter[]=del1,eq,0").then(function (response) {
   var data = $scope.php_crud_api_transform(response.data);
			   $scope.tbl4s = data.tbl4s;
   });
	}
	
	$scope.select_tbl6s = function(x){
	$scope.tbl6s_selected  = x ;
	$scope.refreshTbl7s();
	
	
	}
	//funcion que elimina tbl7s
		$scope.delete_tbl7s = function(x1) {
		console.log("el objeto tbl7s a eliminar es===");
		console.log(x1);
		var url = "api.php/tbl7s/";url = url.concat(x1.id);
		$http.delete(url).then(function (response) {$scope.refreshTbl1s();$scope.refreshTbl7s();});
		}
//fin funcion delete_tbl7s		

//funcion que elimina tbl7s
		$scope.delete_tbl6s = function(x1) {
		console.log("el objeto tbl6s a eliminar es===");
		console.log(x1);		
		var url = "api.php/tbl6s/";url = url.concat(x1.id);
		$http.delete(url).then(function (response) {$scope.refreshTbl1s();$scope.refreshTbl6s();});
		var url2 = "api.php/tbl7s/";
		$scope.tbl7s_list.forEach(function(value, index, array) { 
		var url2 = "api.php/tbl7s/";url2 = url2.concat(value.id);
		$http.delete(url2).then(function (response) { 
		console.log("Vaciando variables");
		$scope.tbl7s_list = [];
		$scope.tbl6s_selected = {};
		});
		
		});
		
		
		
		}
//fin funcion delete_tbl7s		

	
	//refresh refreshTblas		
		$scope.refreshTblas = function() {
		$scope.tbl7s_list = []; //Alamcena la listra de Detalles de tbl6s	
		$http.get("api.php/tblas?order=id,desc&filter[]=del1,eq,0").then(function (response) {
		var data = $scope.php_crud_api_transform(response.data);
		$scope.tblas = data.tblas;
   });
	}
	//end refreshTblas

	$scope.getClass = function() {
	$scope.colors_list = ["w3-orange","w3-brown","w3-gray"];
	return $scope.colors_list[2];
	
	}
		//refresh refreshTblbs		
		$scope.refreshTblbs = function() {
		$scope.tbl7s_list = []; //Alamcena la listra de Detalles de tbl6s	
		$http.get("api.php/tblbs?order=id,desc&filter[]=del1,eq,0").then(function (response) {
		var data = $scope.php_crud_api_transform(response.data);
		$scope.tblbs = data.tblbs;
   });
	}
	//end refreshTblas
		
	//refresh refreshTblws		
		$scope.refreshTbl2s = function() {
		console.log("Tbl4s ya cargadoooo.....");	
		console.log($scope.tbl4_id);
		$scope.tbl4_selected = {};
		$scope.tbl5_selected = {};
		$scope.tbl7s = {};$scope.total = {};
		$scope.tbl2s = [];
		$scope.tbl7s_list = []; //Alamcena la listra de Detalles de tbl6s	
			$http.get("api.php/tbl4s?order=id,desc&filter[]=del1,eq,0").then(function (response) {
   var data = $scope.php_crud_api_transform(response.data);
			   $scope.tbl4s = data.tbl4s;
   });
	}
	//end refreshTbl1
	
	//refresh refreshTbl1s
$scope.refreshTbl1s = function() {
			$http.get("api.php/tbl5s?order=id,desc&filter[]=del1,eq,0").then(function (response) {
   var data = $scope.php_crud_api_transform(response.data);
			   $scope.tbl5s = data.tbl5s;
   });
	}
//end funcion refreshTbl1s

//refresh refreshTbl1s
$scope.refreshTbl7s = function() {
		var URL = "api.php/tbl7s?order=id,desc&filter[]=tbl6s_id,eq,";
		URL = URL.concat($scope.tbl6s_selected.id);
		$http.get(URL).then(function (response) {
				var data = $scope.php_crud_api_transform(response.data);
				$scope.tbl7s_list = data.tbl7s;
				$scope.updateTotals();	
		});
	}
//end funcion refreshTbl1s


//Funcion que actualiza los totales
$scope.updateTotals = function() {
console.log("Actualizando totales............");
$scope.total.ent3  =  0 ;
	$scope.tbl7s_list.forEach(function(value, index, array) {
	$scope.total.ent3  = $scope.total.ent3  +  ( value.ent2 * value.ent1 ) ;
});
console.log("El valor total calculado  ======");
console.log($scope.total.ent3);
var url = "api.php/tbl6s/";url = url.concat($scope.tbl6s_selected.id);
$scope.tbl6s_selected.ent1 = $scope.total.ent3; 
console.log("URL de modificacion total tbl6s ");
console.log(url);
	$http.put(url,$scope.tbl6s_selected).then(function (response){
		$http.get($scope.get_url_tbl6s).then(function (response) {
						var data = $scope.php_crud_api_transform(response.data);
						console.log(data.tbl6s);
						$scope.tbl6s = data.tbl6s; 
						
						});
	});

}


	//funcion que setea el tbl4 seleccionado
$scope.select_tbl4 = function(a) {
			$scope.tbl4_selected = a ;
			$scope.myVar = false;
	}
//fin de funcion que selecciona tbl4


//funcion que setea el tbl4 seleccionado
$scope.select_tbla = function(a) {
			$scope.tbla_selected = a ;
			$scope.myVar2 = false;
	}
//fin de funcion que selecciona tbl4

	//funcion que setea el tbl4 seleccionado
$scope.select_tblb = function(a) {
			$scope.tblb_selected = a ;
			$scope.myVar3 = false;
	}
//fin de funcion que selecciona tbl4

//funcion que setea el select_tbl5 seleccionado
$scope.select_tbl5 = function(a) {
			$scope.tbl7s = {};
			$scope.tbl7s.ent2 = a.ent1;
			$scope.tbl7s.tbl5s_id =  a.id;
			$scope.tbl7s.ent1 =  1;
			$scope.tbl7s.str1 =  a.str1;
			$scope.tbl7s.str2 =  a.str2;
			$scope.tbl7s.ent3 = a.ent1 * 1 ;
				//Save tbl1s via POST
			$scope.tbl.id = null;
			var flag = 0;
			console.log("Tratando de agregar");
			if ($scope.tbl6s_selected === undefined){
				console.log("Es undefined.....");
				$http.post("api.php/tbl6s",$scope.tbl).then(function (response) {			
					$http.get($scope.get_url_tbl6s).then(function (response) {
						var data = $scope.php_crud_api_transform(response.data);
						$scope.tbl6s = data.tbl6s;
						$scope.tbl6s_selected = $scope.tbl6s[0] ;
						$scope.tbl7s.tbl6s_id =  $scope.tbl6s_selected.id;
						$http.post("api.php/tbl7s",$scope.tbl7s).then(function(response) {
							$scope.tbl7s_list.push($scope.tbl7s);
							$scope.myVar2 = false;
							$scope.refreshTbl7s();
							flag = 1;});});
						$scope.refreshTblsAll();
			});
			}
			console.log("Valor del flag====");console.log(flag);
				if (flag === 0){
					console.log("Trata de cargar del selected");
					$scope.tbl7s.tbl6s_id =  $scope.tbl6s_selected.id;
					$http.post("api.php/tbl7s",$scope.tbl7s).then(function(response) {
					$scope.tbl7s_list.push($scope.tbl7s);
					$scope.myVar2 = false;
					$scope.refreshTbl7s();});
			
				}
			}
			
			
//fin de funcion que selecciona select_tbl5
		$scope.identical = function(actual, expected){
		if ( expected === ''){ return true;}
    return actual === parseInt(expected);
}

//funcion que transforma
	$scope.php_crud_api_transform = function(tables) {
	var array_flip = function (trans) {
		var key, tmp_ar = {};
		for (key in trans) {
			tmp_ar[trans[key]] = key;
		}
		return tmp_ar;
	};
	var get_objects = function (tables,table_name,where_index,match_value) {
		var objects = [];
		for (var record in tables[table_name]['records']) {
			record = tables[table_name]['records'][record];
			if (!where_index || record[where_index]==match_value) {
				var object = {};
				for (var index in tables[table_name]['columns']) {
					var column = tables[table_name]['columns'][index];
					object[column] = record[index];
					for (var relation in tables) {
						var reltable = tables[relation];
						for (var key in reltable['relations']) {
							var target = reltable['relations'][key];
							if (target == table_name+'.'+column) {
								column_indices = array_flip(reltable['columns']);
								object[relation] = get_objects(tables,relation,column_indices[key],record[index]);
							}
						}
					}
				}
				objects.push(object);
			}
		}
		return objects;
	};
	tree = {};
	for (var name in tables) {
		var table = tables[name];
		if (!table['relations']) {
			tree[name] = get_objects(tables,name);
			if (table['results']) {
				tree['_results'] = table['results'];
			}
		}
	}
	return tree;
}


//fin funcion que transforma
$scope.refreshTblsAll = function() {
			console.log('Tratando de recuperar listado de TBL6s')
			$scope.tbl6s = [];
			$http.get($scope.get_url_tbl6s).then(function (response) {
			   var data = $scope.php_crud_api_transform(response.data);
			   $scope.tbl6s = data.tbl6s;
			   console.log("Se recupero el siguiente listado de tbl6s= ");
			   console.log($scope.tbl6s);
			});	
			}		
			
			
//fin funcion que transforma
$scope.refreshTbls = function() {
			$scope.tbl3s = [];
			$http.get("api.php/tbl6s?order=id,desc&filter[]=del1,eq,0&filter[]=ent3,eq,1").then(function (response) {
			   var data = $scope.php_crud_api_transform(response.data);
			   $scope.tbl3s = data.tbl3s;
			});	
			}		
		
$scope.headers4 = [{show: "0",column: "id",header:"ID",size:"1"},{show: "1",column: "str1",header:"Codigo",size:"5"},
{show: "1",column: "str2",header:"Descripci√≥n",size:"10"},{show: "1",column: "ent1",header:"Cantidad",size:"1",type:"number"},
{show: "1",column: "ent2",header:"Precio",size:"1",type:"number"},{show: "1",column: "ent3",header:"Total",size:"1",type:"number"}];	


$scope.headers_tbl6s = [{show: "0",column: "id",header:"ID",size:"1"},{show: "1",column: "dat1",header:"Fecha",size:"5"},
{show: "1",column: "time1",header:"Hora",size:"10"},{show: "1",column: "ent1",header:"Total",size:"1",type:"number"},
{show: "1",column: "ent2",header:"Pendiente de Pago",size:"1",type:"number"},{show: "1",column: "ent3",header:"Total",size:"1",type:"number"}];		
	


$scope.headers3 = [{show: "0",column: "id",header:"ID",size:"1"},{show: "1",column: "str1",header:"Codigo",size:"5"},
{show: "1",column: "str2",header:"Descripci√≥n",size:"10"},{show: "1",column: "ent1",header:"Precio",size:"1",type:"number"}];		


		
		$scope.headers2 = [{show: "0",column: "id",header:"ID",size:"1"},{show: "1",column: "str1",header:"Estudiante",size:"5"},
{show: "1",column: "str2",header:"Ruc/CI",size:"10"},{show: "1",column: "str3",header:"Telefono",size:"1"},{show: "1",column: "str4",header:"Correo",size:"1"},
{show: "1",column: "str5",header:"Direcci√≥n",size:"1"}];

		$scope.headers = [{column: "id",header:"ID",size:"1"},{column: "str1",header:"Codigo",size:"5"},
{column: "ent1",header:"Peso m√≠nimo",size:"10"},{column: "tbl1Id",header:"Sabor",size:"1"},{column: "tbl2Id",header:"Ubicaci√≥n",size:"1"},
{column: "ent3",header:"Activo/Inactivo",size:"1"},{column: "str2",header:"Fecha de baja",size:"10"}];
   $scope.filters = {};
   console.log("Seteando fecha");
		$scope.Tbl6 = {}; 
		$scope.tbl = {}; 
 		$scope.tbl.dat1 = moment().format('YYYY-MM-DD');
		$scope.tbl.time1 = moment().format('HH:mm:ss'); 
		console.log("La fecha seteada es ");
		
			$http.get("api.php/tbl6s?filter=ent3,eq,1&order=id,desc").then(function (response) {
			   var data = $scope.php_crud_api_transform(response.data);
			   $scope.tbl3s = data.tbl3s;
			});
			$scope.tbl.ent3 = 1;
	$scope.refreshTblsAll();
	$scope.refreshTbls();
	$scope.refreshTbl1s();
	$scope.refreshTbl2s();
	$scope.refreshTblas();
	$scope.refreshTblbs();
	//Save tbl1s via POST
	$scope.saveTbl = function() {
	console.log('TBL==');console.log($scope.tbl);console.log('==');
	  $scope.tbl.id = null ;
	var data = $scope.tbl;
	$http.post("api.php/tbl6s",data).then(function (response) {$scope.tbl1 = {}; 
	$scope.refreshTbls();
	});
	}
	//Update tbl1s via PUT
	$scope.updateTbl = function() {
	var url = "api.php/tbl6s/";url = url.concat($scope.tbl.id);
	$http.put(url,$scope.tbl).then(function (response){$scope.tbl1 = {};$scope.refreshTbls();});
	}
	
	$scope.baja = function(a) {
	a.str2 = moment().format('B-DD-MM-YY-HH-mm-ss');
	var url = "api.php/tbl6s/";url = url.concat(a.id);
	a.ent3 = 0;
	$http.put(url,a).then(function (response){$scope.tbl1 = {};$scope.refreshTbls();});
	}
	
	$scope.select = function(a) {$scope.tbl = a;var data = $scope.tbl1;}
	$scope.selectTbl1 = function(a) {$scope.tbl.tbl1Id = a.id; $scope.myVar = !$scope.myVar;}
		$scope.selectTbl2 = function(a) {$scope.tbl.tbl2Id = a.id; $scope.myVar2 = !$scope.myVar2;}
	$scope.deleteTbl3 = function(x1) {
		var url = "api.php/tbl6s/";url = url.concat(x1.id);
		$http.delete(url).then(function (response) {$scope.refreshTbls();});
	  	}		
});
        </script>
</div>		
    </body>
</html>